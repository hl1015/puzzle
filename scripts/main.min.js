function Game(a){this.started=!1,this.stage=1,this.num_lines=2,this.scale=1,this.alpha=1,this.fade1=0,this.fade2=0,this.resized=!0,this.loadAssets()}function Holder(a,b,c,d,e,f,g){arguments.length>0?(this.id=a,this.game=b,this.x=c,this.y=d,this.line=e,this.column=f,this.moveble=g):(this.id=0,this.game=null,this.x=0,this.y=0,this.line=null,this.column=null,this.moveble=null),this.occupied=!1}function RunPrefixMethod(a,b){for(var c,d,e=["webkit","moz","ms","o",""],f=0;f<e.length&&!a[c];){if(c=b,""==e[f]&&(c=c.substr(0,1).toLowerCase()+c.substr(1)),c=e[f]+c,d=typeof a[c],"undefined"!=d)return e=[e[f]],"function"==d?a[c]():a[c];f++}}function start(){startGame()}function stop(){stopGame()}function pause(){pauseGame()}function loop(){game.interval=window.requestAnimationFrame(loop,game.canvas),game.render();var a=game.getTimer()-game.time;game.time=game.getTimer(),a>game.maxElapsedTime&&(game.maxElapsedTime=a)}function loadAssets(g,assets){for(i=0;i<assets.length;i++)if("image"==assets[i].type)eval("g."+assets[i].slug+" = new Image();"),eval("g."+assets[i].slug+'.src = "'+assets[i].src+'";'),eval("g."+assets[i].slug+".onload = g.loaded_items++;");else if("audio"==assets[i].type){eval("g."+assets[i].slug+" = document.createElement('audio');"),eval("g."+assets[i].slug+".addEventListener('canplaythrough', itemLoaded(g), false);");var source=document.createElement("source");Modernizr.audio.ogg?(source.type="audio/ogg",source.src=assets[i].src+".ogg"):Modernizr.audio.mp3&&(source.type="audio/mpeg",source.src=assets[i].src+".mp3"),""!=source.src?eval("g."+assets[i].slug+".appendChild(source);"):g.itens_to_load--}}function itemLoaded(a){a.loaded_items++}function resizeGame(){game.apply_scale(),game.started&&game.init()}function Mouse(a){this.game=a,this.x=0,this.y=0,this.down=!1,this.up=!1;var b=this;this.moving=!1,this.interval=null,this.element=document.getElementById("canvas"),Modernizr.touch?(this.element.addEventListener("touchstart",function(a){b.touchstart(a)},!1),this.element.addEventListener("touchmove",function(a){b.touchmove(a)},!1),this.element.addEventListener("touchend",function(a){b.touchend(a)},!1)):(this.element.addEventListener("mousemove",function(a){b.mousemove(a)},!1),this.element.addEventListener("mousedown",function(a){b.mousedown(a)},!1),this.element.addEventListener("mouseup",function(a){b.mouseup(a)},!1))}function Piece(a,b,c,d,e,f,g,h,i,j,k,l,m){arguments.length>0?(this.id=a,this.game=b,this.width=c,this.height=d,this.x=Math.round(e),this.y=Math.round(f),this.target=h,this.startPoint=new Point2D(h.x,h.y),this.holder=i,this.moveble=j,this.placed=k,this.moveble=!1,this.pieceShape=l,this.m=(h.y-this.y)/(h.x-this.x),this.b=h.y-this.m*h.x,this.p=.1):(this.id=0,this.game=null,this.width=10,this.height=10,this.x=0,this.y=0,this.target=null,this.startPoint=null,this.holder=null,this.moveble=!1,this.placed=null,this.pieceShape=null),this.offsetx=Math.round(this.game.scaled_width-this.game.img_width/2),this.offsety=Math.round(this.game.scaled_height-this.game.img_height/2);var n,o,p,q,r;this.offsety+=26,this.tolerance=4e3/this.game.num_lines,this.moving=!1,this.placed=!1,this.widthLegacy=this.width,this.heightLegacy=this.height,this.createdShapes=new Array,this.occupiedinfo=null,this.startHolder=m,this.check1=!1,this.check2=!1;var s=Math.floor(15*Math.random()+1);this.pickedColor,1==s?this.pickedColor="#2F15D4":2==s?this.pickedColor="#D42F15":3==s?this.pickedColor="#F27A18":4==s?this.pickedColor="#15D42F":5==s?this.pickedColor="#F7F716":6==s?this.pickedColor="#FF00E1":7==s?this.pickedColor="#B728FA":8==s?this.pickedColor="#8CFF00":9==s?this.pickedColor="#0EE6E6":10==s?this.pickedColor="#FA4B88":11==s?this.pickedColor="#9C4970":12==s?this.pickedColor="#3B4AED":13==s?this.pickedColor="#134A28":14==s?this.pickedColor="#A16C28":this.pickedColor="#000000";for(var t=1;t<this.pieceShape[2].length;t++)n=this.x+(this.pieceShape[2][t]%5-2)*this.width,o=this.y+(Math.floor(this.pieceShape[2][t]/5)-2)*this.height,p=this.startPoint.x+(this.pieceShape[2][t]%5-2)*this.width,q=this.startPoint.y+(Math.floor(this.pieceShape[2][t]/5)-2)*this.height,r=this.pieceShape[2][t],this.createdShapes[t-1]=new PieceMinor(t,this,this.width,this.height,n,o,new Point2D(p,q),this.pickedColor,r)}function PieceMinor(a,b,c,d,e,f,g,h,i){arguments.length>0?(this.id=a,this.game=b,this.width=c,this.height=d,this.x=e,this.y=f,this.startPoint=g,this.moveble=!1,this.pickedColor=h,this.minorID=i,Math.random()>=.5?this.p=.1:this.p=-.1):(this.id=0,this.game=null,this.width=10,this.height=10,this.x=0,this.y=0,this.target=null,this.startPoint=null,this.minorID=null),this.tolerance=200,this.moving=!1,this.placed=!1,this.widthLegacy=this.width,this.heightLegacy=this.height;Math.floor(6*Math.random()+1)}function Point2D(a,b){arguments.length>0&&(this.x=a,this.y=b)}function reservePlaces(a,b){for(var c=[],d=0;b>d;d++)for(var e=0;b>e;e++)if(1===a){if(void 0==this.protopieces[d][e]&&void 0==this.protopieces[d+1][e]&&b-2>=d)return this.protopieces[d][e]=d+e,this.protopieces[d+1][e]=d+e,c[0]=12,c[1]=13,[d,e,c]}else if(2===a){if(void 0==this.protopieces[d][e]&&void 0==this.protopieces[d][e+1]&&b-2>=e)return this.protopieces[d][e]=d+e,this.protopieces[d][e+1]=d+e,c[0]=12,c[1]=17,[d,e,c]}else if(3===a){if(void 0==this.protopieces[d][e])return this.protopieces[d][e]=d+e,c[0]=12,[d,e,c]}else if(4===a&&b-2>=d&&d>=1){if(void 0==this.protopieces[d][e]&&void 0==this.protopieces[d+1][e]&&void 0==this.protopieces[d-1][e])return this.protopieces[d][e]=d+e,this.protopieces[d+1][e]=d+e,this.protopieces[d-1][e]=d+e,c[0]=12,c[1]=13,c[2]=11,[d,e,c]}else if(5===a&&b-2>=e&&e>=1){if(void 0==this.protopieces[d][e]&&void 0==this.protopieces[d][e+1]&&void 0==this.protopieces[d][e-1])return this.protopieces[d][e]=d+e,this.protopieces[d][e+1]=d+e,this.protopieces[d][e-1]=d+e,c[0]=12,c[1]=17,c[2]=7,[d,e,c]}else if(6===a&&b-2>=e&&b-2>=d&&e>=1){if(void 0==this.protopieces[d][e]&&void 0==this.protopieces[d][e+1]&&void 0==this.protopieces[d][e-1]&&void 0==this.protopieces[d+1][e-1])return this.protopieces[d][e]=d+e,this.protopieces[d+1][e-1]=d+e,this.protopieces[d][e+1]=d+e,this.protopieces[d][e-1]=d+e,c[0]=12,c[1]=7,c[2]=8,c[3]=17,[d,e,c]}else if(7===a&&b-2>=e&&b-2>=d&&e>=1){if(void 0==this.protopieces[d][e]&&void 0==this.protopieces[d][e+1]&&void 0==this.protopieces[d][e-1]&&void 0==this.protopieces[d+1][e]&&void 0==this.protopieces[d+1][e+1])return this.protopieces[d][e]=d+e,this.protopieces[d+1][e+1]=d+e,this.protopieces[d][e+1]=d+e,this.protopieces[d][e-1]=d+e,this.protopieces[d+1][e]=d+e,c[0]=12,c[1]=7,c[2]=13,c[3]=17,c[4]=18,[d,e,c]}else if(8===a&&b-1>=e&&b-2>=d&&e>=1&&d>=1){if(void 0==this.protopieces[d][e]&&void 0==this.protopieces[d+1][e-1]&&void 0==this.protopieces[d-1][e]&&void 0==this.protopieces[d+1][e])return this.protopieces[d][e]=d+e,this.protopieces[d+1][e-1]=d+e,this.protopieces[d-1][e]=d+e,this.protopieces[d+1][e]=d+e,c[0]=12,c[1]=11,c[2]=13,c[3]=8,[d,e,c]}else if(9===a&&b-2>=e&&d>=1&&void 0==this.protopieces[d][e]&&void 0==this.protopieces[d][e+1]&&void 0==this.protopieces[d-1][e])return this.protopieces[d][e]=d+e,this.protopieces[d][e+1]=d+e,this.protopieces[d-1][e]=d+e,c[0]=12,c[1]=17,c[2]=11,[d,e,c];return!1}function StartHolder(a,b,c,d,e,f){arguments.length>0?(this.id=a,this.game=b,this.x=c,this.y=d,this.line=e,this.column=f):(this.id=0,this.game=null,this.x=0,this.y=0,this.line=null,this.column=null)}Game.prototype.loadAssets=function(){this.canvas=document.getElementById("canvas"),this.context=this.canvas.getContext("2d"),this.canvas_bg=document.getElementById("canvas_bg"),this.context_bg=this.canvas.getContext("2d"),document.getElementById("canvas").width=window.innerWidth,document.getElementById("canvas").height=window.innerHeight,document.getElementById("canvas_bg").width=window.innerWidth,document.getElementById("canvas_bg").height=window.innerHeight,document.getElementById("game").height=window.innerHeight,this.original_width=this.canvas.width,this.original_height=this.canvas.height,this.font_size=Math.round(this.canvas.width/8),this.scaled_width=this.canvas.width/this.scale/2,this.scaled_height=this.canvas.height/this.scale/2,this.loaded_items=0,this.loaded=!1,this.interval=null,this.maxElapsedTime=0,this.start_time=0,this.random_image=Math.floor(12*Math.random())+1,this.random_image<10&&(this.random_image=new String("0"+this.random_image)),this.random_image=new String("01"),this.drip=document.getElementById("audio-drip"),this.twang=document.getElementById("audio-twang"),this.bgm=document.getElementById("audio-bgm"),this.chimes=document.getElementById("chimes"),this.items_to_load=1,this.loaded_items=1,eval("this.img = document.getElementById('img"+this.random_image+"');"),this.w_rate=this.canvas.width/this.img.width,this.h_rate=this.canvas.height/this.img.height,this.w_scale=1,this.h_scale=1},Game.prototype.apply_scale=function(){document.getElementById("canvas").width=window.innerWidth,document.getElementById("canvas").height=window.innerHeight,document.getElementById("canvas_bg").width=window.innerWidth,document.getElementById("canvas_bg").height=window.innerHeight,ws=document.getElementById("canvas").width/3.2/document.getElementById("img01").width,hs=document.getElementById("canvas").height/3.2/document.getElementById("img01").height,this.scale=Math.min(ws,hs),this.context.scale(this.scale,this.scale),this.resized=!1},Game.prototype.init=function(){$("#game").css("height",window.innerHeight),this.loaded=!0,this.pieces=new Array,this.holders=new Array,this.startholders=new Array,this.real_holders=new Array,this.placed_pieces=new Array,this.moving=!0,this.selected=null,this.over=null,this.is_over=!1,this.img_width=this.img.width,this.img_height=this.img.height,this.num_pieces=this.num_lines*this.num_lines,this.piece_width=this.img_width/this.num_lines,this.piece_height=this.img_height/this.num_lines,this.realNumLines=this.num_lines/2..toFixed(),this.realNumPieces=this.realNumLines*this.realNumLines,this.protopieces=new Array,this.protopieces.length=this.num_lines,this.protoshapes=new Array,this.sumShapeWeight=0,this.resized&&this.apply_scale(),this.font_size=Math.round(this.canvas.width/8),this.scaled_width=this.canvas.width/this.scale/2,this.scaled_height=this.canvas.height/this.scale/2,this.draw_bg(),this.remaining_time=this.num_pieces*(50/this.stage),this.time_to_complete=this.remaining_time,this.clock_interval=null,this.mouse=new Mouse(this),p,this.auto_snap=!1,this.generateShapes(),this.placeStartHolders(),this.placeHolders(),this.placePieces()},Game.prototype.checkLowerPosition=function(a,b){for(l=0;l<b.length;l++)for(d=0;d<this.startholders.length/2;d++)d===b[l]},Game.prototype.checkHolderRandom=function(a,b){for(k=0;k<b.length;k++)if(a===b[k])return!0;return!1},Game.prototype.placePieces=function(){var a,b=this.protoshapes.length,c=-1,d=-1,e=0,f=0,g=new Array;for(i=0;i<b;i++){c++,x=Math.floor(Math.random()*this.scaled_width*2),y=Math.floor(Math.random()*this.scaled_height*2),f=Math.ceil(this.protoshapes[c][2].length/2);do d=Math.floor(Math.random()*b);while(this.checkHolderRandom(d,g));g.push(d),e=Math.ceil(this.protoshapes[c][2].length/2),a=this.protoshapes[i][0]+this.num_lines*this.protoshapes[i][1],temp=new Piece(c+1,this,this.piece_width,this.piece_height,this.startholders[d].x,this.startholders[d].y,new Point2D(x,y),new Point2D(this.holders[a].x,this.holders[a].y),this.holders[a],!0,!1,this.protoshapes[c],this.startholders[d]),this.pieces.push(temp)}document.getElementById("audio-chimes").play()},Game.prototype.generateShapes=function(){var a=this,b=-1;for(this.sumShapeWeight=0,i=0;i<this.num_pieces;i++)this.protopieces[i]=new Array,this.protopieces[i].length=this.num_lines;for(i=0;i<this.num_pieces;i++)b++,this.protoshapes[b]=function(){return function(){var b,c,d=Math.floor(9*Math.random()+1);if(1===d||2===d){if(c=2,1===d)return b=a.num_pieces>=a.sumShapeWeight+c?reservePlaces.call(a,1,a.num_lines):!1,b||(b=reservePlaces.call(a,3,a.num_lines),c=1),a.sumShapeWeight+=c,i+=c-1,b;if(2===d)return b=a.num_pieces>=a.sumShapeWeight+c?reservePlaces.call(a,2,a.num_lines):!1,b||(b=reservePlaces.call(a,3,a.num_lines),c=1),a.sumShapeWeight+=c,i+=c-1,b}else if(4===d||5===d||9===d){if(c=3,4===d)return b=a.num_pieces>=a.sumShapeWeight+c?reservePlaces.call(a,4,a.num_lines):!1,b||(b=reservePlaces.call(a,3,a.num_lines),c=1),a.sumShapeWeight+=c,i+=c-1,b;if(5===d)return b=a.num_pieces>=a.sumShapeWeight+c?reservePlaces.call(a,5,a.num_lines):!1,b||(b=reservePlaces.call(a,3,a.num_lines),c=1),a.sumShapeWeight+=c,i+=c-1,b;if(9===d)return b=a.num_pieces>=a.sumShapeWeight+c?reservePlaces.call(a,9,a.num_lines):!1,b||(b=reservePlaces.call(a,3,a.num_lines),c=1),a.sumShapeWeight+=c,i+=c-1,b}else if(6===d||8===d){if(c=4,6===d)return b=a.num_pieces>=a.sumShapeWeight+c?reservePlaces.call(a,6,a.num_lines):!1,b||(b=reservePlaces.call(a,3,a.num_lines),c=1),a.sumShapeWeight+=c,i+=c-1,b;if(8===d)return b=a.num_pieces>=a.sumShapeWeight+c?reservePlaces.call(a,8,a.num_lines):!1,b||(b=reservePlaces.call(a,3,a.num_lines),c=1),a.sumShapeWeight+=c,i+=c-1,b}else{if(7!==d)return b=reservePlaces.call(a,3,a.num_lines),c=1,a.sumShapeWeight+=c,i+=c-1,b;if(c=5,7===d)return b=a.num_pieces>=a.sumShapeWeight+c?reservePlaces.call(a,7,a.num_lines):!1,b||(b=reservePlaces.call(a,3,a.num_lines),c=1),a.sumShapeWeight+=c,i+=c-1,b}}}()()},Game.prototype.placeStartHolders=function(){var a,b,c=1,d=Math.round(this.scaled_width-this.img_width/2),e=Math.round(this.scaled_height-this.img_height/2);e+=26;for(var f=0;f<Math.ceil(Math.sqrt(this.protoshapes.length));++f)for(var g=0;g<Math.ceil(Math.sqrt(this.protoshapes.length));++g)a=d-g*this.piece_width-5*this.piece_width/2+this.piece_width/2-this.piece_width/2,b=f*this.piece_height*3+e+this.piece_height/2-this.num_lines*this.piece_height/2,g%3==0&&this.num_lines<4&&this.num_lines>2&&(a=d-g*this.piece_width-4*this.piece_width/2+(this.piece_width/2-this.piece_width),b=f*this.piece_height*3+e+this.piece_height/2-this.num_lines*this.piece_height/2-3*this.piece_height/4),g%3==0&&this.num_lines<3&&(a=d-g*this.piece_width-4*this.piece_width/2+this.piece_width/2,b=f*this.piece_height*2.5+e+this.piece_height/2-this.num_lines*this.piece_height/2),g%3==1&&(a=d+this.piece_width/2+f*this.piece_width*3,b=e+this.num_lines*this.piece_height+g*this.piece_height+this.piece_height/2+this.piece_height/8),g%3==1&&this.num_lines<4&&(a=d+this.piece_width/2+f*this.piece_width*2,b=e+this.num_lines*this.piece_height+g*this.piece_height-g*this.piece_height/1.6+5*this.piece_height/6),g%3==2&&(a=d+this.piece_width/2+f*this.piece_width*3,b=e-g*this.piece_height+3*this.piece_height/8),g%3==2&&this.num_lines<4&&(a=d+this.piece_width/2+f*this.piece_width*2,b=e-4*g*this.piece_height/3+this.piece_height),g%3==1&&this.num_lines<=3&&this.num_lines>2&&(a=g*this.piece_width+d+this.num_lines*this.piece_width+22.5*this.piece_width/8,b=f*this.piece_height*3+e+this.piece_height/2-this.num_lines*this.piece_height/2-3*this.piece_height/4),g%3==1&&this.num_lines<3&&(a=g*this.piece_width+d+this.num_lines*this.piece_width+this.piece_width/2,b=f*this.piece_height*2.5+e+this.piece_height/2-this.num_lines*this.piece_height/2),temp=new StartHolder(c,this,a,b,f,g),this.startholders.push(temp),c++},Game.prototype.placeHolders=function(){this.sumShapeWeight!==this.num_pieces&&alert("wrong weight/pieces number "+this.sumShapeWeight+"   "+this.num_pieces+"\nIt's possible that you should reset the game to avoid unexpected behavior.");var a=1,b=Math.round(this.scaled_width-this.img_width/2),c=Math.round(this.scaled_height-this.img_height/2);c+=26;for(var d=0;d<this.num_lines;++d)for(var e=0;e<this.num_lines;++e)temp=new Holder(a,this,e*this.piece_width+b+this.piece_width/2,d*this.piece_height+c+this.piece_height/2,d,e,!1),this.holders.push(temp),a++},Game.prototype.checkPlace=function(a,b){var c,d,e,f=0,g=0;if(b.occupied)return!1;for(j=0;j<a.createdShapes.length;j++)for(k=0;k<this.game.holders.length;k++)if(c=a.createdShapes[j].x-this.game.holders[k].x,d=a.createdShapes[j].y-this.game.holders[k].y,e=c*c+d*d,f=c>=f?c:f,g=d>=g?d:g,e<=a.tolerance&&this.game.holders[k].occupied===!0)return!1;return f>=a.width*this.game.num_lines-(a.width/2+1)?!1:g>=a.height*this.game.num_lines-(a.height/2+1)?!1:!0},Game.prototype.render=function(){if(this.draw_bg(),this.loaded){for(var a=0;a<this.holders.length;a++)holder=this.holders[a],holder.draw();for(var a=0;a<this.startholders.length;a++)startholder=this.startholders[a],startholder.draw();for(var b=new Array,c=!1,a=0;a<this.pieces.length;a++)piece=this.pieces[a],!c&&piece.mouse_is_over()&&(c=!0),piece.placed?piece!=this.selected&&piece.draw():b.push(piece),this.selected||(!this.over||this.over.id<piece.id||piece.mouse_is_over())&&piece.mouse_is_over()&&(this.over=piece);for(var a=0;a<b.length;a++)b[a].draw();this.selected&&this.selected.draw(),c||(this.over=null),null!=this.selected&&this.selected.moveble&&(this.selected.x=Math.round(this.mouse.x),this.selected.y=Math.round(this.mouse.y)),this.draw_remaining(),this.remaining_time<=0?(this.remaining_time=0,pauseGame(),confirm("Timeup! Try again")&&(this.is_over=!1,this.init(),startGame())):this.is_over?(pauseGame(),$("#stage").html("Stage "+this.stage+" completed!"),$("#pieces").html(this.protoshapes.length+" pieces in "+(this.time_to_complete-this.remaining_time)+"s"),$("#modal-success").modal()):this.protoshapes.length==this.placed_pieces.length&&(this.is_over=!0)}else if(this.items_to_load>0&&this.loaded_items==this.items_to_load){this.items_to_load=0;setTimeout("game.init();",1500)}else this.draw_loading()},Game.prototype.draw_bg=function(){this.scale||(this.scale=1),this.context.fillStyle="rgba(125, 125, 125, 1)",this.context_bg.fillRect(0,0,this.canvas_bg.width/this.scale,this.canvas_bg.height/this.scale);var a=Math.round(this.scaled_width-this.img_width/2),b=Math.round(this.scaled_height-this.img_height/2);b+=26,this.context_bg.globalAlpha=.2,this.context_bg.drawImage(this.img,a,b,this.img_width,this.img_height)},Game.prototype.draw_remaining=function(){this.remaining_time<=50&&(this.fade1=this.fade1+.01*this.alpha,this.fade1>=.6?this.alpha=-1:this.fade1<=.2&&(this.alpha=1),this.context.fillStyle="rgba(255, 255, 255, "+this.fade1+")",this.context.strokeStyle="rgba(0, 0, 0, 0.5)",this.context.lineWidth=2,this.context.font="bold "+this.font_size+"px Arial",this.context.textBaseline="middle",this.context.textAlign="center",this.context.fillText(parseInt(game.remaining_time),this.scaled_width,this.scaled_height))},Game.prototype.draw_loading=function(){this.fade1=this.fade1+.025,this.fade1>=1&&(this.fade1=0),this.fade2=1-this.fade1,this.context.fillStyle="rgba(255, 255, 255, "+this.fade2+")",this.context.strokeStyle="rgba(255, 255, 255, "+this.fade1+")",this.context.font="bold "+this.font_size+"px Arial",this.context.textBaseline="middle",this.context.textAlign="center",this.context.lineWidth=5,this.context.strokeText("LOADING",this.scaled_width,this.scaled_height),this.context.fillText("LOADING",this.scaled_width,this.scaled_height)},Game.prototype.clockTick=function(){this.remaining_time--},Game.prototype.getTimer=function(){return(new Date).getTime()-this.start_time},Game.prototype.nextStage=function(resetStr){eval("this.img = document.getElementById('img01')"),this.is_over=!1,this.stage++,"reset"===resetStr&&this.stage--,"reset"!==resetStr&&this.num_lines++,this.init(),startGame()},Holder.prototype.occupy=function(){var a,b,c,d=new Array;for(i=0;i<this.game.holders.length;i++)a=this.game.selected.x-this.game.holders[i].x,b=this.game.selected.y-this.game.holders[i].y,c=a*a+b*b,c<=this.game.selected.tolerance&&(this.game.holders[i].occupied=!0,d.push(i));for(j=0;j<this.game.selected.createdShapes.length;j++)for(i=0;i<this.game.holders.length;i++)a=this.game.selected.createdShapes[j].x-this.game.holders[i].x,b=this.game.selected.createdShapes[j].y-this.game.holders[i].y,c=a*a+b*b,c<=this.game.selected.tolerance&&(this.game.holders[i].occupied=!0,d.push(i));return d},Holder.prototype.deOccupy=function(a){for(i=0;i<a.length;i++)this.game.holders[a[i]].occupied=!1},Holder.prototype.draw=function(){this.game.context.lineWidth=2,this.game.context.strokeRect(this.x-this.game.piece_width/2,this.y-this.game.piece_height/2,this.game.piece_width,this.game.piece_height)},function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,22-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),Modernizr.fullscreen;var game=new Game,interval=null,gameInterval=null;game.debug=!1,m={game:game},interv=function(){interval=setTimeout("game.mouse.moving = false; document.getElementById('moving').value = false; intervClear();",500)},intervClear=function(){clearInterval(interval)},stopGame=function(){clearInterval(gameInterval),game.started=!1,stopSFX(),stopBGM(),window.cancelAnimationFrame(game.interval),$("#home").addClass("active"),$("#play").show(),$(".control").hide(),$("#canvas, #canvas_bg").hide(),$(".content").show()},startGame=function(){clearInterval(gameInterval),gameInterval=setInterval(function(){game.remaining_time--},1e3),game.started=!0,startSFX(),startBGM(),loop(),$("#home").removeClass("active"),$("#canvas, .control, .abs").show(),$(".content, #play, #exitfullscreen, #bgm, #sfx, #autosnap").hide(),$(".container, .footer").hide(),$("#body").css("padding","0px"),$("#body").css("margin","0px")},pauseGame=function(){clearInterval(gameInterval),game.started=!1,window.cancelAnimationFrame(game.interval),$(".control").hide(),$("#play").show(),$("#btn-play").show()},stopSFX=function(){game.drip.volume=0,game.twang.volume=0,game.drip.pause(),game.twang.pause(),$("#sfxoff").hide(),$("#sfx").show()},startSFX=function(){game.drip.volume=1,game.twang.volume=1,$("#sfxoff").show(),$("#sfx").hide()},stopBGM=function(){game.bgm.volume=0,game.bgm.pause(),$("#bgmoff").hide(),$("#bgm").show()},startBGM=function(){game.bgm.volume=1,game.bgm.play(),$("#bgmoff").show(),$("#bgm").hide()},autoSnap=function(){game.auto_snap=!0,$("#autosnapoff").show(),$("#autosnap").hide()},autoSnapOff=function(){game.auto_snap=!1,$("#autosnapoff").hide(),$("#autosnap").show()},fullscreen=function(){RunPrefixMethod(game.canvas,"RequestFullScreen")},exitfullscreen=function(){RunPrefixMethod(document,"CancelFullScreen")},window.addEventListener("resize",resizeGame,!1),window.addEventListener("orientationchange",resizeGame,!1),$(function(){$(".popover-test").popover(),$("#next").click(function(){game.nextStage(),$("#modal-success").modal("hide")}),$("#play, #btn-play, #play-btn-lg").click(function(){start()}),$("#btn-pause").click(function(){pause()}),$("#btn-reset").click(function(){game.nextStage("reset")}),$("#btn-fullscreen").click(function(){fullscreen()}),$("#btn-exitfullscreen").click(function(){exitfullscreen()}),$("#btn-bmg-on").click(function(){startBGM()}),$("#btn-bmg-off").click(function(){stopBGM()}),$("#btn-sfx-on").click(function(){startSFX()}),$("#btn-sfx-off").click(function(){stopSFX()}),$("#btn-autosnap-on").click(function(){autoSnap()}),$("#btn-autosnap-off").click(function(){autoSnapOff()}),$("#play-top").click(function(){start()}),$("#btn-home").click(function(){self.location.href="./index.html"}),$("#modal-success").removeClass("show")}),Mouse.prototype.keyup=function(a){console.log(a.keyCode)},Mouse.prototype.isOverBall=function(a){var b=!1;return this.x>0&&this.y>0&&a.x>0&&a.y>0&&this.x>=a.x-a.radius&&this.x<=a.x+a.radius&&this.y>=a.y-a.radius&&this.y<=a.y+a.radius&&(b=!0,this.game.debug&&console.log("over "+this.x+" "+this.y)),b},Mouse.prototype.isOverPiece=function(a){var b=new Array;b[0]=new Point2D(a.x-a.width/2,a.y-a.height/2),b[1]=new Point2D(a.x+a.width/2,a.y-a.height/2),b[2]=new Point2D(a.x+a.width/2,a.y+a.height/2),b[3]=new Point2D(a.x-a.width/2,a.y+a.height/2),pt=new Point2D(this.x,this.y);for(var c=!1,d=-1,e=b.length,f=e-1;++d<e;f=d)(b[d].y<=pt.y&&pt.y<b[f].y||b[f].y<=pt.y&&pt.y<b[d].y)&&pt.x<(b[f].x-b[d].x)*(pt.y-b[d].y)/(b[f].y-b[d].y)+b[d].x&&(c=!c);return c},Mouse.prototype.isOverRect=function(a,b,c,d){var e=new Array;e[0]=a,e[1]=b,e[2]=c,e[3]=d,pt=new Point2D(this.x,this.y);for(var f=!1,g=-1,h=e.length,i=h-1;++g<h;i=g)(e[g].y<=pt.y&&pt.y<e[i].y||e[i].y<=pt.y&&pt.y<e[g].y)&&pt.x<(e[i].x-e[g].x)*(pt.y-e[g].y)/(e[i].y-e[g].y)+e[g].x&&(f=!f);return f},Mouse.prototype.mousemove=function(a){body_scrollLeft=document.body.scrollLeft,element_scrollLeft=document.documentElement.scrollLeft,body_scrollTop=document.body.scrollTop,element_scrollTop=document.documentElement.scrollTop,offsetLeft=this.element.offsetLeft,offsetTop=this.element.offsetTop;var b,c;a.pageX||a.pageY?(b=a.pageX,c=a.pageY):(b=a.clientX+body_scrollLeft+element_scrollLeft,c=a.clientY+body_scrollTop+element_scrollTop),b/=this.game.scale,c/=this.game.scale,this.moving=!0,interv(),this.x=b,this.y=c,this.event=a,this.game.debug&&console.log("move "+b)},Mouse.prototype.mousedown=function(a){this.down=!0,this.up=!1,this.event=a,this.game.over&&(this.game.selected=this.game.over,this.game.selected.placed&&(this.game.placed_pieces.splice(this.game.placed_pieces.indexOf(this.game.selected),1),this.game.selected.placed=!1,Holder.prototype.deOccupy.call(this,this.game.selected.occupiedinfo),this.game.selected.occupiedinfo=null)),this.game.debug&&console.log("down")},Mouse.prototype.mouseup=function(a){a.preventDefault(),this.up=!0,this.down=!1,this.event=a,this.game.selected&&(this.checkNear=this.game.selected.near()),this.game.selected&&this.checkNear&&!this.game.selected.placed?(this.game.selected.x=this.checkNear.x,this.game.selected.y=this.checkNear.y,this.game.selected.placed=!0,this.game.selected.occupiedinfo=Holder.prototype.occupy.call(this),this.game.placed_pieces.push(this.game.selected),0!=this.game.drip.currentTime&&(this.game.drip.currentTime=0),this.game.drip.play()):this.game.selected&&!this.checkNear&&(this.game.selected.p=0,this.game.selected.placed=!1,0!=this.game.twang.currentTime&&(this.game.twang.currentTime=0),this.game.twang.play()),this.game.selected=null,this.game.debug&&console.log("up")},Mouse.prototype.touchstart=function(a){this.game.drip.play(),a.preventDefault(),this.moving=!1,this.down=!0,this.up=!1,this.event=a,this.game.debug&&console.log("touch start")},Mouse.prototype.touchend=function(a){this.game.debug&&console.log("touchend"),a.preventDefault(),this.moving=!1,this.up=!0,this.down=!1,this.x=-1,this.y=-1,this.game.selected&&(this.checkNear=this.game.selected.near()),this.game.selected&&this.checkNear&&!this.game.selected.placed?(this.game.selected.x=this.checkNear.x,this.game.selected.y=this.checkNear.y,this.game.selected.placed=!0,this.game.selected.occupiedinfo=Holder.prototype.occupy.call(this),this.game.placed_pieces.push(this.game.selected),0!=this.game.drip.currentTime&&(this.game.drip.currentTime=0),this.game.drip.play()):this.game.selected&&!this.checkNear&&(this.game.selected.p=0,this.game.selected.placed=!1,0!=this.game.twang.currentTime&&(this.game.twang.currentTime=0),this.game.twang.play()),this.game.selected=null},Mouse.prototype.touchmove=function(a){a.preventDefault(),body_scrollLeft=document.body.scrollLeft,element_scrollLeft=document.documentElement.scrollLeft,body_scrollTop=document.body.scrollTop,element_scrollTop=document.documentElement.scrollTop,offsetLeft=this.element.offsetLeft,offsetTop=this.element.offsetTop;var b,c,d=a.touches[0];d.pageX||d.pageY?(b=d.pageX,c=d.pageY):(b=d.clientX+body_scrollLeft+element_scrollLeft,c=d.clientY+body_scrollTop+element_scrollTop),b/=this.game.scale,c/=this.game.scale,this.moving=!0,this.x=b,this.y=c,this.event=a,this.game.over&&(this.game.selected=this.game.over,this.game.selected.placed&&(this.game.placed_pieces.splice(this.game.placed_pieces.indexOf(this.game.selected),1),this.game.selected.placed=!1,Holder.prototype.deOccupy.call(this,this.game.selected.occupiedinfo),this.game.selected.occupiedinfo=null)),this.game.debug&&console.log("touchmove "+b)},Piece.prototype.draw=function(){if(this.moveble||this.placed){this.placed?this.game.context.globalAlpha=1:this.game.is_over?this.game.context.globalAlpha=1:this.game.context.globalAlpha=.8,this.game.context.fillStyle="rgba(255, 255, 255, 0.5)",this==this.game.selected?this.game.context.fillStyle="rgba(0, 0, 255, 0.1)":this.game.over==this&&(this.game.context.fillStyle="rgba(255, 0, 0, 0.1)"),this.game.selected==this&&this.near()&&(this.game.context.fillStyle="rgba(0, 255, 0, 0.1)",1!=this.game.auto_snap||this.placed||(this.game.selected.x=this.game.selected.target.x,this.game.selected.y=this.game.selected.target.y,this.game.selected.placed=!0,this.game.selected.moveble=!1,this.game.placed_pieces.push(this.game.selected),0!=this.game.drip.currentTime&&(this.game.drip.currentTime=0),this.game.drip.play())),this.game.context.fillStyle=this.pickedColor,this.game.context.fillRect(this.x-this.game.piece_width/2,this.y-this.game.piece_height/2,this.game.piece_width,this.game.piece_height);for(var a=0;a<this.createdShapes.length;a++)this.createdShapes[a].draw();!this.game.is_over}else{this.game.context.globalAlpha=1,this.p=1.05*this.p,this.startPoint.x>this.x&&(this.startPoint.x-=this.p),this.startPoint.x<this.x&&(this.startPoint.x+=this.p),this.startPoint.y>this.y&&(this.startPoint.y-=this.p),this.startPoint.y<this.y&&(this.startPoint.y+=this.p),this.startPoint.x>=this.x&&this.startPoint.x<this.x+60&&!this.check1&&(this.startPoint.x=this.x,this.check1=!0),this.startPoint.x<=this.x&&this.startPoint.x>this.x-60&&!this.check1&&(this.startPoint.x=this.x,this.check1=!0),this.startPoint.y>=this.y&&this.startPoint.y<this.y+60&&!this.check2&&(this.startPoint.y=this.y,this.check2=!0),this.startPoint.y<=this.y&&this.startPoint.y>this.y-60&&!this.check2&&(this.startPoint.y=this.y,this.check2=!0),this.check1&&this.check2&&(this.moveble=!0,this.iniPoint=new Point2D(this.x,this.y)),this.game.context.fillStyle=this.pickedColor,this.game.context.fillRect(this.startPoint.x-this.game.piece_width/2,this.startPoint.y-this.game.piece_height/2,this.game.piece_width,this.game.piece_height);for(var a=0;a<this.createdShapes.length;a++)this.createdShapes[a].draw()}this.game.debug&&console.log("pieace: "+this.id+" drew")},Piece.prototype.near=function(){var a,b,c,d=!1;for(i=0;i<this.game.holders.length;i++)a=this.x-this.game.holders[i].x,b=this.y-this.game.holders[i].y,c=a*a+b*b,c<=this.tolerance&&this.game.checkPlace.call(this,this,this.game.holders[i])&&(d=this.game.holders[i]);return this.game.debug&&console.log(this.id+": "+c),d},Piece.prototype.mouse_is_over=function(){if(this.game.mouse.isOverPiece(this)&&this.game.started)return!0;if(this.game.started)for(var a=0;a<this.createdShapes.length;a++)if(this.createdShapes[a].mouse_is_over())return!0;return!1},PieceMinor.prototype.draw=function(){this.game.moveble||this.game.placed?(this.x=this.game.x+(this.minorID%5-2)*this.width,this.y=this.game.y+(Math.floor(this.minorID/5)-2)*this.height,this.startPoint.x=this.game.startPoint.x+(this.minorID%5-2)*this.width,this.startPoint.y=this.game.startPoint.y+(Math.floor(this.minorID/5)-2)*this.height,this.game.game.context.fillStyle=this.pickedColor,this.game.game.context.fillRect(this.x-this.game.game.piece_width/2,this.y-this.game.game.piece_height/2,this.game.game.piece_width,this.game.game.piece_height),!this.game.is_over):(this.x=this.game.x+(this.minorID%5-2)*this.width,this.y=this.game.y+(Math.floor(this.minorID/5)-2)*this.height,this.startPoint.x=this.game.startPoint.x+(this.minorID%5-2)*this.width,this.startPoint.y=this.game.startPoint.y+(Math.floor(this.minorID/5)-2)*this.height,this.game.game.context.fillStyle=this.pickedColor,this.game.game.context.fillRect(this.startPoint.x-this.game.game.piece_width/2,this.startPoint.y-this.game.game.piece_height/2,this.game.game.piece_width,this.game.game.piece_height)),
this.game.debug&&console.log("pieace: "+this.id+" drew")},PieceMinor.prototype.mouse_is_over=function(){return this.game.game.mouse.isOverPiece(this)},StartHolder.prototype.draw=function(){};